const filterKanji=(e,t,n)=>{const a={};switch(Object.entries(e).filter(([e,n])=>{const[o,r]=Object.entries(t)[0];(n[o]===r||Array.isArray(r)&&r.includes(n[o]))&&(a[e]=n)}),n){case"keys":return Object.keys(a);case"values":return Object.values(a);default:return a}},getChecked=e=>{const t=[];for(const n of e)n.checked&&(isNaN(n.value)?t.push(n.value):t.push(Number(n.value)));return t},addOrdNumWords=e=>{const t=e%10,n=e%100;switch(n){case 11:case 12:case 13:return`${e}th`;default:switch(t){case 1:return`${e}st`;case 2:return`${e}nd`;case 3:return`${e}rd`;default:return`${e}th`}}},multilingual=e=>e[pageLang],addNensei=e=>multilingual({ja:`${e}年生`,en:`${addOrdNumWords(e)} grade`}),shuffle=e=>{for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e},sliceByNum=(e,t)=>{const n=new Array(Math.ceil(e.length/t)).fill([]);return n.map((n,a)=>e.slice(t*a,t*(a+1)))},removeNewline=e=>e.replace(/[\n\t]/g,"");fetch("../data/kanjidata.json").then(e=>e.ok?e.json():Promise.reject(new Error("Failed to fetch a json file."))).then(e=>{const t={};return Object.entries(e).forEach(([e,n])=>{if(n.hasOwnProperty("studies"))n.studies.forEach(a=>{a.strokesNum=n.strokesNum,a.readingForSort=n.readingForSort,t[`${e}${a.reading?`（${a.reading}）`:""}`]=a});else{if(!0===n.isUniqueReading&&!0!==n.noNeedToSplit){const e=[];n.questions.forEach(t=>{const n=t.phrase.findIndex(e=>e.hasOwnProperty("answer")),a=t.phrase[n],o=[...a.answer.matchAll(/\p{sc=Han}/gu)],r=o.map(e=>{const o=structuredClone(t),r=[];return 0!==e.index&&r.push(a.answer.slice(0,e.index)),r.push({answer:e[0]}),e.index+1!==a.answer.length&&r.push(a.answer.slice(e.index+1)),o.phrase[n].answer=r,o});e.push(...r)}),n.questions=e}t[e]=n}}),t}).then(e=>(Object.values(e).forEach(e=>{e.hasOwnProperty("annotation")&&(e.questions.forEach(t=>{t.annotation=e.annotation}),delete e.annotation)}),e)).then(e=>{function t(t){const a=document.querySelector("#tab01 .tabContents .tabWrapper.activeContent").id.replace("Tab",""),[s,c]=(()=>{try{switch(a){case"grade":const n=getChecked(i);if(0===n.length)throw t&&alert(multilingual({ja:"学習年を一つ以上選択してください。",en:"Please select one or more study grades."})),new Error("Not selected grades");return[n,Math.max(...n)];case"select":const o=getChecked(f);if(0===o.length)throw t&&alert(multilingual({ja:"漢字を一つ以上選択してください。",en:"Please select one or more Kanji."})),new Error("Not selected Kanji");return[o,Math.max(...o.map(t=>e[t].grade))]}}catch(e){return console.log(e),[null,null]}})();if(null===s)return!1;for(const e of N){const t=Array.from(e.children).map(e=>[e.dataset.grade,e]);t.forEach(([e,t])=>{const[n,a]=e.split("-").map(e=>""===e?"":Number(e));t.hidden=!(()=>e.match("-")?""===a?n<=c:n<=c&&c<=a:n===c)()})}const d=(()=>{switch(a){case"select":return shuffle(s);case"grade":return shuffle(filterKanji(e,{grade:s},"keys"))}})(),l=d.length;for(x.textContent=l;L[0];)L[0].remove();const u=sliceByNum(d,8);if(u.forEach(t=>{const n=document.createElement("div");n.classList.add("qRow"),t.forEach(t=>{const a=e[t].questions,o=a[Math.floor(Math.random()*a.length)],r=o.hasOkurigana?"okurigana":"tango",s=b[r].content.cloneNode(!0),c=s.querySelector(".phrase"),d=o.phrase.map((e,t)=>{if(e.hasOwnProperty("answer")){const n=s.querySelector(".reading");n.textContent=e.reading;const a=s.querySelector(".answer");if("okurigana"===r)return a.textContent=e.answer,e.answer.length>=5&&a.classList.add("long"),n;{const o=s.querySelector(".main");if(0===t&&o.classList.add("firstNode"),Array.isArray(e.answer)){o.classList.add("unique");const t=s.querySelector(".blank"),r=e.answer.map((e,n)=>e.hasOwnProperty("answer")?(0===n&&t.classList.add("firstNode"),a.textContent=e.answer,t):e);o.append(...r);const c=e.answer.reduce((e,t)=>e+("object"==typeof t?t.answer.length:t.length),0);e.reading.length<=c?n.classList.add("short"):e.reading.length===c+1?n.classList.add("long1"):e.reading.length>=c+3&&n.classList.add("long2")}else a.textContent=e.answer,e.reading.length>=3&&n.classList.add("long");return o}}if(e.hasOwnProperty("furigana")){const t=document.createElement("span");return t.classList.add("ruby"),t.textContent=e.text,t.dataset.ruby=e.furigana,t}return e});if(c.append(...d),o.hasOwnProperty("annotation")){const e=document.createElement("span");e.classList.add("annotation"),e.textContent=`※${A(o.annotation)}`,s.querySelector(".question").appendChild(e)}n.appendChild(s)}),o.appendChild(n)}),q.appendChild(o),!1===r){r=!0,j.removeAttribute("hidden"),[v,C].forEach(e=>{e.removeAttribute("hidden"),document.getElementById(`${e.id}Clone`).removeAttribute("hidden")});const e=multilingual({ja:"問題を更新",en:"Update questions"});k.textContent=e,document.getElementById("makeQuizBtnClone").textContent=e}n()}function n(){const e=j.offsetWidth/B.offsetWidth;B.style.setProperty("--scale",e);let t=0;for(const e of j.children)e!==B&&(t+=e.offsetHeight);j.style.height=B.offsetHeight*B.style.getPropertyValue("--scale")+t+"px"}function a(){const e=document.getElementsByClassName("answer");for(const t of e)t.hidden=!I.checked}const o=new DocumentFragment;let r=!1;const s=[...new Set(Object.values(e).map(e=>e.grade))].sort((e,t)=>e-t),c=document.getElementById("gradeOptTemp");s.forEach(e=>{const t=c.content.cloneNode(!0),n=t.querySelector(".gradeOpt");n.value=e,n.insertAdjacentText("afterend",addNensei(e)),o.appendChild(t)}),document.getElementById("gradeOpts").appendChild(o);const d=document.getElementById("randomQNum"),i=document.getElementsByClassName("gradeOpt"),l=()=>{const t=getChecked(i);d.max=filterKanji(e,{grade:t},"keys").length,"0"===d.value&&(d.value=40),Number(d.value)>Number(d.max)&&(d.value=d.max)};l();for(const e of i)e.addEventListener("change",()=>{l();const e=getChecked(i);s.forEach(t=>{const n=document.querySelector(`#gradeDetails${t}`);if(n.hidden=!e.includes(t),!e.includes(t))for(const e of n.querySelectorAll(".kanjiChoice:checked"))e.checked=!1,e.dispatchEvent(new Event("change"))}),r&&t()});const u=document.getElementById("gradeDetailsTemp"),h=document.getElementById("strokesNumGroupTemp"),m=document.getElementById("kanjiChoiceTemp");s.forEach(n=>{const a=u.content.cloneNode(!0),s=a.querySelector("details");s.id=`gradeDetails${n}`,a.querySelector("h2").textContent=addNensei(n);const c=a.querySelector(".selectAll");c.addEventListener("change",()=>{const e=c.checked;s.querySelectorAll(".kanjiChoice").forEach(t=>{t.checked=!e,t.dispatchEvent(new Event("change"))}),c.nextSibling.textContent=multilingual(e?{ja:"全て選択",en:"Select all"}:{ja:"全て選択解除",en:"Deselect all"}),r&&t()});const d=filterKanji(e,{grade:n}),i=[...new Set(Object.values(d).map(e=>e.strokesNum))].sort((e,t)=>e-t);i.forEach(t=>{const n=h.content.cloneNode(!0);n.querySelector("h3").textContent=multilingual(void 0===t?{ja:"特別な読み方",en:"Unique readings"}:{ja:`${t}画`,en:`${t} stroke${1!==t?"s":""}`});const a=filterKanji(d,void 0===t?{isUniqueReading:!0}:{strokesNum:t},"keys").sort((t,n)=>e[t].readingForSort.localeCompare(e[n].readingForSort,"ja")),o=n.querySelector(".kanjiChoicesDiv");a.forEach(e=>{const t=m.content.cloneNode(!0),n=t.querySelector(".kanjiChoice");n.value=e,n.insertAdjacentText("afterend",e),o.appendChild(t)}),s.appendChild(n)}),o.appendChild(a)}),u.parentElement.appendChild(o),i[0].dispatchEvent(new Event("change"));const g=document.getElementById("selectRandomlyBtn"),p=()=>{for(const e of document.querySelectorAll(".kanjiChoice:checked"))e.checked=!1,e.dispatchEvent(new Event("change"));const e=document.querySelectorAll(".gradeDetails:not([hidden]) .kanjiChoice");for(const t of shuffle(Array.from(e)).slice(0,d.value))t.checked=!0,t.dispatchEvent(new Event("change"));r&&t()};g.addEventListener("click",p),d.addEventListener("focus",()=>{g.removeEventListener("click",p)}),d.addEventListener("blur",()=>{g.addEventListener("click",p)}),d.addEventListener("change",p);const f=document.getElementsByClassName("kanjiChoice"),E=document.getElementById("qCounter");for(const e of f)e.addEventListener("change",()=>{e.checked?e.parentElement.classList.add("checked"):e.parentElement.classList.remove("checked");const t=getChecked(f).length,n=0===t?0:Math.ceil((t-16)/24)+1;E.textContent=multilingual({ja:`${t}問（A4 ${n}枚）`,en:`${t} question${1===t?"":"s"}（${n} A4 sheet${1===n?"":"s"}）`})}),e.addEventListener("click",()=>{r&&t("manual")});const y=document.getElementById("originalBtns");for(const e of y.children){const t=e.cloneNode(!0);t.id=`${e.id}Clone`,t.addEventListener("click",()=>{e.click()}),o.appendChild(t)}document.getElementById("copiedBtns").appendChild(o);const w=document.getElementById("panel");window.addEventListener("scroll",()=>{w.hidden=y.getBoundingClientRect().top<window.innerHeight});const k=document.getElementById("makeQuizBtn"),v=document.getElementById("printQuizBtn"),C=document.getElementById("printAnsBtn"),j=document.getElementById("quizSection"),B=document.getElementById("quizPrint"),N=document.getElementsByClassName("kanjiHira"),q=document.getElementById("qRows"),L=document.getElementsByClassName("qRow"),b={okurigana:document.getElementById("okuriganaTemp"),tango:document.getElementById("tangoTemp")},S=document.getElementById("quizDesc");S.innerHTML=removeNewline(S.innerHTML);const x=document.getElementById("maxScore");k.addEventListener("click",()=>{t("manual")});const A=e=>{switch(e.type){case"isnot":return`「${e.value}」ではない`}};window.addEventListener("resize",n);const I=document.getElementById("showAnsBtn");I.addEventListener("change",a);const $=e=>{const t="printAnsBtn"===e.currentTarget.id;window.onbeforeprint=function(){I.checked=t,a()};const n=I.checked;window.onafterprint=function(){I.checked=n,a()},window.print()};v.addEventListener("click",$),C.addEventListener("click",$),window.addEventListener("beforeprint",()=>{const e=document.createElement("div");e.id="printArea",document.body.appendChild(e),e.appendChild(B.cloneNode(!0)),document.body.firstElementChild.setAttribute("hidden","")}),window.addEventListener("afterprint",()=>{const e=document.body.firstElementChild;!0===e.hidden&&(e.hidden=!1,document.getElementById("printArea").remove())})});