function getMultiple(elems){const values=[];for(let i=0;i<elems.length;i++)if(elems[i].checked){const num=Number(elems[i].value);Number.isNaN(num)?values.push(elems[i].value):values.push(Number(elems[i].value))}return values}function ordinalSuffix(num){var j=num%10,k=num%100;return 1==j&&11!=k?num+"st":2==j&&12!=k?num+"nd":3==j&&13!=k?num+"rd":num+"th"}function addNensei(grade,lang){switch(lang){case"ja":return`${grade}年生`;case"en":return`${ordinalSuffix(grade)} grade`}}function addNenseiToElem(grade,elem,query){supportedLang.forEach(lang=>{elem.querySelector(`${query||""}:lang(${lang})`).textContent=addNensei(grade,lang)})}function filterBy(data,options,keyValueAll){const filtered=Object.keys(data).filter(key=>{let bools=[];if(Object.entries(options).forEach(([optKey,optValue])=>{let bool="";switch(typeOf(optValue)){case"string":case"boolean":case"number":bool=data[key][optKey]===optValue;break;case"array":bool=optValue.includes(data[key][optKey])}bools.push(bool)}),!bools.includes(!1))return!0});switch(keyValueAll){case"key":var result=filtered;break;case"value":var result=filtered.map(key=>{data[key]});break;case"all":var result={};filtered.forEach(key=>{result[key]=data[key]})}return result}function shuffle(array){const newArray=Array(array.length);return array.forEach(elem=>{const key=Math.floor(Math.random()*(array.length+1));newArray.splice(key,0,elem)}),newArray.filter(value=>value)}function typeOf(obj){return Object.prototype.toString.call(obj).slice(8,-1).toLowerCase()}function sliceByNum(array,num){let newArr=new Array(Math.ceil(array.length/num)).fill([]);return newArr=newArr.map((_,i)=>array.slice(num*i,num*(i+1))),newArr}let fragment=document.createDocumentFragment();fetch("../data/kanjidata.json").then(response=>response.ok?response.json():Promise.reject(new Error("JSONファイルにアクセスできません。"))).then(jsonData=>{const newData={};return Object.entries(jsonData).forEach(([kanji,data1])=>{if(data1.readings)data1.readings.forEach(data2=>{data2.strokesNum=data1.strokesNum,data2.readingForSort=data1.readingForSort;const key=`${kanji}${data2.reading?"（"+data2.reading+"）":""}`;newData[key]=data2});else{if(data1.isUniqueReading&&!0!==data1.noNeedToSplit){const newQuizzes=[];data1.quizzes.forEach(quiz=>{quiz.phrase.forEach((item,i)=>{if(item.answer){const answer=item.answer,kanjis=[...item.answer.matchAll(/[一-龠]/g)];kanjis.forEach(matched=>{const newQuiz=JSON.parse(JSON.stringify(quiz)),newAnswerArr=[],before=answer.substr(0,matched.index),newAnswer=answer.substr(matched.index,matched.index+1),after=answer.substr(matched.index+1);""!==before&&newAnswerArr.push({text:before}),newAnswerArr.push({answer:newAnswer}),""!==after&&newAnswerArr.push({text:after}),newQuiz.phrase[i].answer=newAnswerArr,newQuizzes.push(newQuiz)})}})}),data1.quizzes=newQuizzes}newData[kanji]=data1}}),newData}).then(kanjiData=>{const makeTestBtn=document.getElementById("makeTest"),testSectionE=document.getElementById("testSection"),allGrades=[...new Set(Object.values(kanjiData).map(elem=>elem.studyGrade))].sort((a,b)=>a-b),studyGradesOptTemp=document.getElementById("studyGradesOptTemp");fragment=document.createDocumentFragment(),allGrades.forEach(grade=>{const clone=studyGradesOptTemp.content.cloneNode(!0),studyGradesOptE=clone.querySelector("[name=studyGradesOpt]");studyGradesOptE.value=grade,studyGradesOptE.addEventListener("change",reselectGrades),addNenseiToElem(grade,clone),fragment.append(clone)}),studyGradesOptTemp.parentElement.append(fragment);const studyGradesOpts=document.getElementsByName("studyGradesOpt"),detailsTemp=document.getElementById("detailsTemp"),strokeNumTitleTemp=document.getElementById("strokeNumTitleTemp"),kanjiChoicesTemp=document.getElementById("kanjiChoicesTemp");fragment=document.createDocumentFragment(),allGrades.forEach(grade=>{const clone1=detailsTemp.content.cloneNode(!0),detailsE=clone1.querySelector("details");detailsE.id=`details${grade}`,addNenseiToElem(grade,clone1,"h2 > ");const selectAllBtn=clone1.querySelector(".selectAllBtn");selectAllBtn.addEventListener("click",()=>{const inputs=detailsE.querySelectorAll("[name=kanjiChoices]"),wantToSelect=selectAllBtn.classList.contains("select");for(const input of inputs)input.checked=wantToSelect,input.dispatchEvent(new Event("change"));selectAllBtn.classList.toggle("select");const text={ja:{wantToSelect:"選択",wantToDeselect:"選択解除"},en:{wantToSelect:"Select",wantToDeselect:"Deselect"}};Object.entries(text).forEach(([lang,value])=>{const elem=selectAllBtn.querySelector(`:lang(${lang})`);elem.textContent=elem.textContent.replace(wantToSelect?value.wantToSelect:value.wantToDeselect,wantToSelect?value.wantToDeselect:value.wantToSelect)})});const kanjis=filterBy(kanjiData,{studyGrade:grade},"all"),strokeNums=[...new Set(Object.values(kanjis).map(elem=>elem.strokesNum))];strokeNums.sort((a,b)=>a-b),strokeNums.forEach(strokeNum=>{let filteredByStrokeNum;const clone2=strokeNumTitleTemp.content.cloneNode(!0);void 0===strokeNum?(filteredByStrokeNum=filterBy(kanjis,{isUniqueReading:!0},"key"),clone2.querySelector(":lang(ja)").textContent="特別な読み方",clone2.querySelector(":lang(en)").textContent="Unique readings"):(filteredByStrokeNum=filterBy(kanjis,{strokesNum:strokeNum},"key"),clone2.querySelector(":lang(ja)").textContent=`${strokeNum}画`,clone2.querySelector(":lang(en)").textContent=`${strokeNum} stroke${1!==strokeNum?"s":""}`);const kanjiChoicesDiv=clone2.querySelector(".kanjiChoicesDiv");detailsE.append(clone2),filteredByStrokeNum.sort((a,b)=>{const readingA=kanjiData[a].readingForSort,readingB=kanjiData[b].readingForSort;return readingA<=readingB?-1:1}),filteredByStrokeNum.forEach(kanji=>{const clone3=kanjiChoicesTemp.content.cloneNode(!0);clone3.querySelector("[name=kanjiChoices]").value=kanji;const kanjiChoicesLabelE=clone3.querySelector(".kanjiChoices");let html=kanjiChoicesLabelE.innerHTML;html=html.trim(),html+=kanji,kanjiChoicesLabelE.innerHTML=html,kanjiChoicesDiv.append(clone3)})}),fragment.append(clone1)}),detailsTemp.parentElement.append(fragment);const btnsE=document.getElementById("btns"),footerMenu=document.getElementById("footerMenu"),parent=document.createElement("div");parent.classList.add("btns");const btns={};for(const btn of btnsE.children){const clone=btn.cloneNode(!0);clone.classList.add(`${clone.id}Clone`),btns[clone.id]=[btn,clone],clone.removeAttribute("id"),parent.append(clone)}footerMenu.append(parent);const kanjiChoicesEs=document.getElementsByName("kanjiChoices"),qCounterEs=document.getElementsByClassName("qCounter"),sheetsCounterEs=document.getElementsByClassName("sheetsCounter"),beVerb=document.getElementById("beVerb"),nouns=document.getElementsByClassName("nouns");for(const elem of kanjiChoicesEs)elem.addEventListener("change",()=>{elem.checked?elem.parentElement.classList.add("checked"):elem.parentElement.classList.remove("checked");const qNum=getMultiple(kanjiChoicesEs).length,sheetsNum=0===qNum?0:Math.ceil(Math.ceil((qNum-16)/8)/3)+1;for(let i=0;i<qCounterEs.length;i++){qCounterEs[i].textContent=qNum,sheetsCounterEs[i].textContent=sheetsNum,beVerb.textContent=1===qNum?"is":"are";for(const noun of nouns)1===(noun.classList.contains("qNum")?qNum:sheetsNum)?noun.textContent=noun.textContent.replace(/s$/,""):noun.textContent+=/s$/.test(noun.textContent)?"":"s"}}),elem.addEventListener("click",()=>{testSectionE.hasAttribute("hidden")||makeTestBtn.click()});const randomSelectBtn=document.getElementById("randomSelect"),qNumE=document.getElementById("qNum");function randomSelect(){for(const choiceE of document.querySelectorAll("[name=kanjiChoices]:checked"))choiceE.checked=!1,choiceE.dispatchEvent(new Event("change"));const shuffled=shuffle([...document.querySelectorAll(".gradeDetails:not([hidden]) [name=kanjiChoices]")]).slice(0,qNumE.value);shuffled.forEach(choiceE=>{choiceE.checked=!0,choiceE.dispatchEvent(new Event("change"))}),testSectionE.hasAttribute("hidden")||makeTestBtn.click()}randomSelectBtn.addEventListener("click",randomSelect),qNumE.addEventListener("focus",()=>{randomSelectBtn.removeEventListener("click",randomSelect)}),qNumE.addEventListener("blur",()=>{randomSelectBtn.addEventListener("click",randomSelect)}),qNumE.addEventListener("change",randomSelect);const r1=footerMenu.getBoundingClientRect();function reselectGrades(){const selectedGrades=getMultiple(studyGradesOpts),maxKanjiNum=filterBy(kanjiData,{studyGrade:selectedGrades},"key").length;qNumE.max=maxKanjiNum,"0"===qNumE.value&&(qNumE.value=40),Number(qNumE.value)>Number(qNumE.max)&&(qNumE.value=qNumE.max);const text={ja:"",en:""};selectedGrades.forEach((grade,i)=>{text.ja+=addNensei(grade,"ja"),text.en+=addNensei(grade,"en"),selectedGrades.length!==i+1&&(text.ja+="、",text.en+=selectedGrades.length===i+2?" and ":", ")}),document.querySelector(":lang(ja) > .selectedGrades").textContent=text.ja,document.querySelector(":lang(en) > .selectedGrades").textContent=text.en,allGrades.forEach(grade=>{const details=document.getElementById(`details${grade}`);selectedGrades.includes(grade)?details.removeAttribute("hidden",""):details.setAttribute("hidden","")});const deselectedGradeChoicesEs=document.querySelectorAll(".gradeDetails[hidden] [name=kanjiChoices]:checked");for(const choiceE of deselectedGradeChoicesEs)choiceE.checked=!1,choiceE.dispatchEvent(new Event("change"));testSectionE.hasAttribute("hidden")||makeTestBtn.click()}window.addEventListener("scroll",()=>{const r2=makeTestBtn.getBoundingClientRect().top+window.pageYOffset-600;r2<r1.top+window.pageYOffset?footerMenu.setAttribute("hidden",""):footerMenu.removeAttribute("hidden")}),reselectGrades();const printTestBtn=document.getElementById("printTest"),printAnswerBtn=document.getElementById("printAnswer");btns.makeTest.forEach(btn=>{btn.addEventListener("click",makeTest)});const tabContent=document.querySelectorAll("#tab01 .tabContents .tabWrapper"),testPrintE=document.getElementById("testPrint"),maxScoreE=document.getElementById("maxScore"),okuriganaTemp=document.getElementById("okuriganaTemp"),tangoTemp=document.getElementById("tangoTemp");function makeQuestions(clone,textData,i,basisNum,basisE,kind){if(textData.answer){const reading=clone.querySelector(".reading");reading.textContent+=textData.reading||"";const answer=clone.querySelector(".answer");if("okurigana"===kind&&textData.answer.length>=4&&answer.classList.add("long"),"array"===typeOf(textData.answer)){basisE.classList.add("unique");const basisNum2=textData.answer.findIndex(elem=>elem.answer),basisE2=clone.querySelector(".blank");textData.answer.forEach((textData2,i2)=>{makeQuestions(clone,textData2,i2,basisNum2,basisE2,"unique")}),textData.reading.length<=textData.answer.length?reading.classList.add("short2"):textData.reading.length<=textData.answer.length+1?reading.classList.add("short1"):textData.reading.length>=textData.answer.length+3&&reading.classList.add("long")}else answer.textContent=textData.answer,"tango"===kind&&textData.reading.length>=3&&reading.classList.add("long")}else switch(i){case basisNum-1:basisE.before(textData.text);break;case basisNum+1:basisE.after(textData.text)}}function makeTest(){const kind=[...tabContent].filter(elem=>elem.classList.contains("activeContent"))[0].id,selectedGrades=getMultiple(studyGradesOpts);if(!selectedGrades.length)return void alert("学習年をひとつ以上選択してください。");if("select"===kind&&!getMultiple(kanjiChoicesEs).length)return void alert("漢字をひとつ以上選択してください。");const rows=document.getElementsByClassName("row");for(;rows[0];)rows[0].remove();let qKanji;switch(kind){case"grade":qKanji=filterBy(kanjiData,{studyGrade:selectedGrades},"key"),qKanji=shuffle(qKanji);break;case"select":qKanji=shuffle(getMultiple(kanjiChoicesEs))}const qNum=qKanji.length;maxScoreE.textContent=qNum,qKanji=sliceByNum(qKanji,8),fragment=document.createDocumentFragment(),qKanji.forEach(kanjis=>{const div=document.createElement("div");div.classList.add("row"),kanjis.forEach(kanji=>{const quizzes=kanjiData[kanji].quizzes,phraseData=quizzes[Math.floor(Math.random()*quizzes.length)];let clone,basisE,kind;phraseData.hasOkurigana?(clone=okuriganaTemp.content.cloneNode(!0),basisE=clone.querySelector(".reading"),kind="okurigana"):(clone=tangoTemp.content.cloneNode(!0),basisE=clone.querySelector(".main"),kind="tango");const basisNum=phraseData.phrase.findIndex(elem=>elem.answer);phraseData.phrase.forEach((textData,i)=>{makeQuestions(clone,textData,i,basisNum,basisE,kind)}),clone.children[0].innerHTML=clone.children[0].innerHTML.replace(/[\n\t]/g,""),div.append(clone)}),fragment.append(div)}),testPrintE.append(fragment);const maxGrade=Math.max(...selectedGrades),maxGradeEs=document.querySelectorAll(`[data-grade="${maxGrade}"]`);for(const maxGradeE of maxGradeEs)maxGradeE.removeAttribute("hidden");const otherGrades=allGrades.filter(num=>num!==maxGrade);otherGrades.forEach(grade=>{const otherGradesEs=document.querySelectorAll(`[data-grade="${grade}"]`);for(const otherGradesE of otherGradesEs)otherGradesE.setAttribute("hidden","")}),showAnswer(),changeHeightOfTestSection(),testSectionE.hasAttribute("hidden")&&(btns.makeTest.forEach(btn=>{testSectionE.removeAttribute("hidden");const text_ja="問題を更新",text_en="Update questions";btn.querySelector(":lang(ja)").textContent=text_ja,btn.querySelector(":lang(en)").textContent=text_en,[printTestBtn,printAnswerBtn].forEach(btn=>{btns[btn.id].forEach(btn2=>{btn2.removeAttribute("hidden")})})}),changeScaleOfPrint())}function changeScaleOfPrint(){const scale=testPrintE.parentElement.offsetWidth/testPrintE.offsetWidth;testPrintE.style.setProperty("--scale",scale),changeHeightOfTestSection()}function changeHeightOfTestSection(){let height=0;for(const sibling of testPrintE.parentElement.children)sibling!==testPrintE&&(height+=sibling.offsetHeight);testPrintE.parentElement.style.height=testPrintE.offsetHeight*testPrintE.style.getPropertyValue("--scale")+height+"px"}window.addEventListener("resize",changeScaleOfPrint);const answerBtn=document.getElementById("answer");function showAnswer(){const answerEs=document.getElementsByClassName("answer");for(const elem of answerEs)elem.removeAttribute("hidden");if(answerBtn.checked)for(const elem of answerEs)elem.removeAttribute("hidden");else for(const elem of answerEs)elem.setAttribute("hidden","")}answerBtn.addEventListener("change",showAnswer),[printTestBtn,printAnswerBtn].forEach(btn=>{const wantToShowAnswer=btn===printAnswerBtn;btns[btn.id].forEach(btn2=>{btn2.addEventListener("click",()=>{window.onbeforeprint=function(){answerBtn.checked=wantToShowAnswer,showAnswer()};const original=answerBtn.checked;window.onafterprint=function(){answerBtn.checked=original,showAnswer()},window.print()})})}),window.addEventListener("beforeprint",()=>{const printArea=document.createElement("div");printArea.setAttribute("id","printArea"),document.body.appendChild(printArea),printArea.appendChild(testPrintE.cloneNode(!0)),document.body.firstElementChild.setAttribute("hidden","")}),window.addEventListener("afterprint",()=>{const elem=document.body.firstElementChild;elem.hasAttribute("hidden")&&(elem.removeAttribute("hidden"),document.getElementById("printArea").remove())}),lang()}).catch(e=>{console.error(e.message)});