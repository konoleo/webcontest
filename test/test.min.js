const filterKanji=(object,condition,option)=>{const res={};switch(Object.entries(object).filter(([kanji,value])=>{const[condKey,condValue]=Object.entries(condition)[0];(value[condKey]===condValue||Array.isArray(condValue)&&condValue.includes(value[condKey]))&&(res[kanji]=value)}),option){case"keys":return Object.keys(res);case"values":return Object.values(res);default:return res}},getChecked=elems=>{const values=[];for(const elem of elems)elem.checked&&(isNaN(elem.value)?values.push(elem.value):values.push(Number(elem.value)));return values},addOrdNumWords=num=>{const onesPlace=num%10,tensPlace=num%100;switch(tensPlace){case 11:case 12:case 13:return`${num}th`;default:switch(onesPlace){case 1:return`${num}st`;case 2:return`${num}nd`;case 3:return`${num}rd`;default:return`${num}th`}}},multilingual=texts=>texts[pageLang],addNensei=grade=>multilingual({ja:`${grade}年生`,en:`${addOrdNumWords(grade)} grade`}),shuffle=array=>{for(let i=array.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[array[i],array[j]]=[array[j],array[i]]}return array},sliceByNum=(array,num)=>{const blankArray=new Array(Math.ceil(array.length/num)).fill([]);return blankArray.map((_,i)=>array.slice(num*i,num*(i+1)))},removeNewline=html=>html.replace(/[\n\t]/g,"");fetch("../data/kanjidata.json").then(res=>res.ok?res.json():Promise.reject(new Error("Failed to fetch a json file."))).then(json=>{const newJson={};return Object.entries(json).forEach(([kanji,data])=>{if(data.hasOwnProperty("studies"))data.studies.forEach(study=>{study.strokesNum=data.strokesNum,study.readingForSort=data.readingForSort,newJson[`${kanji}${study.reading?`（${study.reading}）`:""}`]=study});else{if(!0===data.isUniqueReading&&!0!==data.noNeedToSplit){const newQuestionsAll=[];data.questions.forEach(question=>{const ansObjIndex=question.phrase.findIndex(text=>text.hasOwnProperty("answer")),ansObj=question.phrase[ansObjIndex],kanjis=[...ansObj.answer.matchAll(/\p{sc=Han}/gu)],newQuestions=kanjis.map(kanjiInAns=>{const newQuestion=structuredClone(question),newAns=[];return 0!==kanjiInAns.index&&newAns.push(ansObj.answer.slice(0,kanjiInAns.index)),newAns.push({answer:kanjiInAns[0]}),kanjiInAns.index+1!==ansObj.answer.length&&newAns.push(ansObj.answer.slice(kanjiInAns.index+1)),newQuestion.phrase[ansObjIndex].answer=newAns,newQuestion});newQuestionsAll.push(...newQuestions)}),data.questions=newQuestionsAll}newJson[kanji]=data}}),newJson}).then(json=>(Object.values(json).forEach(data=>{data.hasOwnProperty("annotation")&&(data.questions.forEach(question=>{question.annotation=data.annotation}),delete data.annotation)}),json)).then(json=>{const fragment=new DocumentFragment;let hasMadeQuiz=!1;const allGrades=[...new Set(Object.values(json).map(data=>data.grade))].sort((a,b)=>a-b),gradeOptTemp=document.getElementById("gradeOptTemp");allGrades.forEach(grade=>{const clone=gradeOptTemp.content.cloneNode(!0),checkbox=clone.querySelector(".gradeOpt");checkbox.value=grade,checkbox.insertAdjacentText("afterend",addNensei(grade)),fragment.appendChild(clone)}),document.getElementById("gradeOpts").appendChild(fragment);const randomQNum=document.getElementById("randomQNum"),gradeOptElems=document.getElementsByClassName("gradeOpt"),setMaxValue=()=>{const selectedGrades=getChecked(gradeOptElems);randomQNum.max=filterKanji(json,{grade:selectedGrades},"keys").length,"0"===randomQNum.value&&(randomQNum.value=40),Number(randomQNum.value)>Number(randomQNum.max)&&(randomQNum.value=randomQNum.max)};setMaxValue();for(const gradeOpt of gradeOptElems)gradeOpt.addEventListener("change",()=>{setMaxValue();const selectedGrades=getChecked(gradeOptElems);allGrades.forEach(grade=>{document.querySelector(`#gradeDetails${grade}`).hidden=!selectedGrades.includes(grade)}),hasMadeQuiz&&updateQuiz()});const gradeDetailsTemp=document.getElementById("gradeDetailsTemp"),strokesNumGroupTemp=document.getElementById("strokesNumGroupTemp"),kanjiChoiceTemp=document.getElementById("kanjiChoiceTemp");allGrades.forEach(grade=>{const detailsClone=gradeDetailsTemp.content.cloneNode(!0),detailsElem=detailsClone.querySelector("details");detailsElem.id=`gradeDetails${grade}`,detailsClone.querySelector("h2").textContent=addNensei(grade);const selectAllInput=detailsClone.querySelector(".selectAll");selectAllInput.addEventListener("change",()=>{const isSelect=selectAllInput.checked;detailsElem.querySelectorAll(".kanjiChoice").forEach(choice=>{choice.checked=!isSelect,choice.dispatchEvent(new Event("change"))}),selectAllInput.nextSibling.textContent=multilingual(isSelect?{ja:"全て選択",en:"Select all"}:{ja:"全て選択解除",en:"Deselect all"}),hasMadeQuiz&&updateQuiz()});const filteredByGrade=filterKanji(json,{grade:grade}),strokesNums=[...new Set(Object.values(filteredByGrade).map(value=>value.strokesNum))].sort((a,b)=>a-b);strokesNums.forEach(strokesNum=>{const strokeClone=strokesNumGroupTemp.content.cloneNode(!0);strokeClone.querySelector("h3").textContent=multilingual(void 0===strokesNum?{ja:"特別な読み方",en:"Unique readings"}:{ja:`${strokesNum}画`,en:`${strokesNum} stroke${1!==strokesNum?"s":""}`});const filteredByStroke=filterKanji(filteredByGrade,void 0===strokesNum?{isUniqueReading:!0}:{strokesNum:strokesNum},"keys").sort((a,b)=>json[a].readingForSort.localeCompare(json[b].readingForSort,"ja")),choicesDiv=strokeClone.querySelector(".kanjiChoicesDiv");filteredByStroke.forEach(kanji=>{const choiceClone=kanjiChoiceTemp.content.cloneNode(!0),choiceElem=choiceClone.querySelector(".kanjiChoice");choiceElem.value=kanji,choiceElem.insertAdjacentText("afterend",kanji),choicesDiv.appendChild(choiceClone)}),detailsElem.appendChild(strokeClone)}),fragment.appendChild(detailsClone)}),gradeDetailsTemp.parentElement.appendChild(fragment),gradeOptElems[0].dispatchEvent(new Event("change"));const selectRandomlyBtn=document.getElementById("selectRandomlyBtn"),selectRandomly=()=>{for(const choice of document.querySelectorAll(".kanjiChoice:checked"))choice.checked=!1,choice.dispatchEvent(new Event("change"));const choices=document.querySelectorAll(".gradeDetails:not([hidden]) .kanjiChoice");for(const choice of shuffle(Array.from(choices)).slice(0,randomQNum.value))choice.checked=!0,choice.dispatchEvent(new Event("change"));hasMadeQuiz&&updateQuiz()};selectRandomlyBtn.addEventListener("click",selectRandomly),randomQNum.addEventListener("focus",()=>{selectRandomlyBtn.removeEventListener("click",selectRandomly)}),randomQNum.addEventListener("blur",()=>{selectRandomlyBtn.addEventListener("click",selectRandomly)}),randomQNum.addEventListener("change",selectRandomly);const kanjiChoiceElems=document.getElementsByClassName("kanjiChoice"),qCounterInPanel=document.getElementById("qCounter");for(const choice of kanjiChoiceElems)choice.addEventListener("change",()=>{choice.checked?choice.parentElement.classList.add("checked"):choice.parentElement.classList.remove("checked");const selectedNum=getChecked(kanjiChoiceElems).length,sheetsNum=0===selectedNum?0:Math.ceil((selectedNum-16)/24)+1;qCounterInPanel.textContent=multilingual({ja:`${selectedNum}問（A4 ${sheetsNum}枚）`,en:`${selectedNum} question${1===selectedNum?"":"s"}（${sheetsNum} A4 sheet${1===sheetsNum?"":"s"}）`})}),choice.addEventListener("click",()=>{hasMadeQuiz&&updateQuiz()});const originalBtns=document.getElementById("originalBtns");for(const btn of originalBtns.children){const btnClone=btn.cloneNode(!0);btnClone.id=`${btn.id}Clone`,btnClone.addEventListener("click",()=>{btn.click()}),fragment.appendChild(btnClone)}document.getElementById("copiedBtns").appendChild(fragment);const panel=document.getElementById("panel");window.addEventListener("scroll",()=>{panel.hidden=originalBtns.getBoundingClientRect().top<window.innerHeight});const makeQuizBtn=document.getElementById("makeQuizBtn"),printQuizBtn=document.getElementById("printQuizBtn"),printAnsBtn=document.getElementById("printAnsBtn"),quizSection=document.getElementById("quizSection"),quizPrint=document.getElementById("quizPrint"),kanjiHiraElems=document.getElementsByClassName("kanjiHira"),qRowsElem=document.getElementById("qRows"),qRow=document.getElementsByClassName("qRow"),qTemps={okurigana:document.getElementById("okuriganaTemp"),tango:document.getElementById("tangoTemp")},quizDesc=document.getElementById("quizDesc");quizDesc.innerHTML=removeNewline(quizDesc.innerHTML);const maxScore=document.getElementById("maxScore");makeQuizBtn.addEventListener("click",()=>{updateQuiz()});const addAnnotation=annotation=>{switch(annotation.type){case"isnot":return`「${annotation.value}」ではない`}};function updateQuiz(){const quizType=document.querySelector("#tab01 .tabContents .tabWrapper.activeContent").id.replace("Tab",""),[selected,selectedMaxGrade]=(()=>{try{switch(quizType){case"grade":const selectedGrades=getChecked(gradeOptElems);if(0===selectedGrades.length)throw alert(multilingual({ja:"学習年を一つ以上選択してください。",en:"Please select one or more study grades."})),new Error("Not selected");return[selectedGrades,Math.max(...selectedGrades)];case"select":const selectedKanji=getChecked(kanjiChoiceElems);if(0===selectedKanji.length)throw alert(multilingual({ja:"漢字を一つ以上選択してください。",en:"Please select one or more Kanji."})),new Error("Not selected");return[selectedKanji,Math.max(...selectedKanji.map(kanji=>json[kanji].grade))]}}catch(error){return[null,null]}})();if(null===selected)return!1;for(const kanjiHiraElem of kanjiHiraElems){const gradeAttrs=Array.from(kanjiHiraElem.children).map(elem=>[elem.dataset.grade,elem]);gradeAttrs.forEach(([attr,elem])=>{const[start,end]=attr.split("-").map(num=>""===num?"":Number(num));elem.hidden=!(attr.match("-")?""===end?start<=selectedMaxGrade:start<=selectedMaxGrade&&selectedMaxGrade<=end:start===selectedMaxGrade)})}const kanjiToUse=(()=>{switch(quizType){case"select":return shuffle(selected);case"grade":return shuffle(filterKanji(json,{grade:selected},"keys"))}})(),qNum=kanjiToUse.length;for(maxScore.textContent=qNum;qRow[0];)qRow[0].remove();const slicedKanji=sliceByNum(kanjiToUse,8);if(slicedKanji.forEach(kanjis=>{const div=document.createElement("div");div.classList.add("qRow"),kanjis.forEach(kanji=>{const questions=json[kanji].questions,question=questions[Math.floor(Math.random()*questions.length)],qType=question.hasOkurigana?"okurigana":"tango",clone=qTemps[qType].content.cloneNode(!0),phraseElem=clone.querySelector(".phrase"),nodesToAdd=question.phrase.map((text,i)=>{if(text.hasOwnProperty("answer")){const readingElem=clone.querySelector(".reading");readingElem.textContent=text.reading;const ansElem=clone.querySelector(".answer");if("okurigana"===qType)return ansElem.textContent=text.answer,text.answer.length>=5&&ansElem.classList.add("long"),readingElem;{const mainElem=clone.querySelector(".main");if(0===i&&mainElem.classList.add("firstNode"),Array.isArray(text.answer)){mainElem.classList.add("unique");const blankElem=clone.querySelector(".blank"),ansNodeToAdd=text.answer.map((ans,k)=>ans.hasOwnProperty("answer")?(0===k&&blankElem.classList.add("firstNode"),ansElem.textContent=ans.answer,blankElem):ans);mainElem.append(...ansNodeToAdd);const ansLength=text.answer.reduce((prev,curr)=>prev+("object"==typeof curr?curr.answer.length:curr.length),0);text.reading.length<=ansLength?readingElem.classList.add("short"):text.reading.length===ansLength+1?readingElem.classList.add("long1"):text.reading.length>=ansLength+3&&readingElem.classList.add("long2")}else ansElem.textContent=text.answer,text.reading.length>=3&&readingElem.classList.add("long");return mainElem}}if(text.hasOwnProperty("furigana")){const rubyElem=document.createElement("span");return rubyElem.classList.add("ruby"),rubyElem.textContent=text.text,rubyElem.dataset.ruby=text.furigana,rubyElem}return text});if(phraseElem.append(...nodesToAdd),question.hasOwnProperty("annotation")){const annotationElem=document.createElement("span");annotationElem.classList.add("annotation"),annotationElem.textContent=`※${addAnnotation(question.annotation)}`,clone.querySelector(".question").appendChild(annotationElem)}div.appendChild(clone)}),fragment.appendChild(div)}),qRowsElem.appendChild(fragment),!1===hasMadeQuiz){hasMadeQuiz=!0,quizSection.removeAttribute("hidden"),[printQuizBtn,printAnsBtn].forEach(btn=>{btn.removeAttribute("hidden"),document.getElementById(`${btn.id}Clone`).removeAttribute("hidden")});const newText=multilingual({ja:"問題を更新",en:"Update questions"});makeQuizBtn.textContent=newText,document.getElementById("makeQuizBtnClone").textContent=newText}changeScaleOfPrint()}const showAnsBtn=document.getElementById("showAnsBtn");function changeScaleOfPrint(){const scale=quizSection.offsetWidth/quizPrint.offsetWidth;quizPrint.style.setProperty("--scale",scale);let height=0;for(const sibling of quizSection.children)sibling!==quizPrint&&(height+=sibling.offsetHeight);quizSection.style.height=quizPrint.offsetHeight*quizPrint.style.getPropertyValue("--scale")+height+"px"}showAnsBtn.addEventListener("change",()=>{showAnsBtn.checked?quizPrint.classList.add("showingAns"):quizPrint.classList.remove("showingAns")}),window.addEventListener("resize",changeScaleOfPrint);const printQuiz=e=>{const original=showAnsBtn.checked;showAnsBtn.checked="printAnsBtn"===e.currentTarget.id,showAnsBtn.dispatchEvent(new Event("change")),window.print(),showAnsBtn.checked=original,showAnsBtn.dispatchEvent(new Event("change"))};printQuizBtn.addEventListener("click",printQuiz),printAnsBtn.addEventListener("click",printQuiz),window.addEventListener("beforeprint",()=>{const printArea=document.createElement("div");printArea.id="printArea",document.body.appendChild(printArea),printArea.appendChild(quizPrint.cloneNode(!0)),document.body.firstElementChild.setAttribute("hidden","")}),window.addEventListener("afterprint",()=>{const elem=document.body.firstElementChild;!0===elem.hidden&&(elem.hidden=!1,document.getElementById("printArea").remove())})});