fetch("../data/kanjidata.json").then(response=>response.ok?response.json():Promise.reject(new Error("JSONファイルにアクセスできません。"))).then(kanjiData=>{function filterByYear(year){const kanjiArr=[];return Object.keys(kanjiData).forEach(element=>{year.includes(kanjiData[element].studyYear)&&kanjiArr.push(element)}),kanjiArr}function ramdomSelect(qNum,year){const kanjiArr=shuffle(filterByYear(year)),difference=kanjiArr.length-qNum;return difference>0&&kanjiArr.splice(0,difference),kanjiArr}function getMultiple(elems){const values=[];for(let i=0;i<elems.length;i++)if(elems[i].checked){const num=Number(elems[i].value);Number.isNaN(num)?values.push(elems[i].value):values.push(Number(elems[i].value))}return values}function ordinalSuffix(i){var j=i%10,k=i%100;return 1==j&&11!=k?i+"st":2==j&&12!=k?i+"nd":3==j&&13!=k?i+"rd":i+"th"}const settingTabs=document.getElementsByName("settingTab"),settingTabpanel=document.getElementsByClassName("settingTabpanel"),questionsDiv=document.getElementById("questionsDiv"),studyYearBtns=document.getElementsByName("studyYear"),qNumElem=document.getElementById("qNum"),kanjiChoicesElems=document.getElementsByName("kanjiChoices"),answerBtn=document.getElementById("answer"),makeTestBtn=document.getElementById("makeTest"),printBtn=document.getElementById("printTest"),printAnsBtn=document.getElementById("printAnswer"),testAreaElem=document.getElementById("testArea"),maxScoreElem=document.getElementById("maxScore"),activeTab=document.getElementById("activeTab");activeTab.firstElementChild.setAttribute("checked",""),activeTab.firstElementChild===settingTabs[0]?settingTabpanel[1].setAttribute("hidden",""):settingTabpanel[0].setAttribute("hidden","");for(let i=0;i<settingTabs.length;i++)settingTabs[i].addEventListener("click",()=>{settingTabpanel[i].removeAttribute("hidden"),settingTabpanel[Math.pow(0,i)].setAttribute("hidden",""),settingTabs[i].parentElement.id="activeTab",settingTabs[Math.pow(0,i)].parentElement.removeAttribute("id")});function changeChoices(){const detailsElems=settingTabpanel[1].getElementsByTagName("details"),studyYear=getMultiple(studyYearBtns);if(detailsElems.length){studyYear.forEach((year,index)=>{detailsElems[year-1].removeAttribute("hidden"),0===index&&detailsElems[year-1].open&&detailsElems[year-1].setAttribute("open","true")});const otherYears=[1,2,3].filter(num=>!studyYear.includes(num));otherYears.forEach(year=>{detailsElems[year-1].setAttribute("hidden","")})}else studyYear.forEach((year,index)=>{const choices=filterByYear([year]);if(choices.length){const details=document.createElement("details");0===index&&details.setAttribute("open","true");const summary=document.createElement("summary"),h3=document.createElement("h3");h3.innerHTML=`\n\t\t\t\t\t\t<span lang="ja">${year}年生</span>\n\t\t\t\t\t\t<span lang="en-us" hidden>${ordinalSuffix(year)} grade</span>\n\t\t\t\t\t`,summary.appendChild(h3),details.appendChild(summary);const button=document.createElement("button");button.textContent=`${year}年生の漢字をすベて選択`,button.innerHTML=`\n\t\t\t\t\t\t<span lang="ja">${year}年生の漢字をすベて選択</span>\n\t\t\t\t\t\t<span lang="en-us" hidden>Select all ${ordinalSuffix(year)} grade Kanji</span>\n\t\t\t\t\t`,button.setAttribute("id",`all${year}check`),details.appendChild(button);const div=document.createElement("div");div.classList.add("kanjiChoicesDiv"),details.appendChild(div);const temp=document.getElementById("kanjiChoicesTemp");choices.forEach(choice=>{const clone=temp.content.cloneNode(!0),labelElem=clone.querySelector("label");labelElem.children[0].value=choice;let html=labelElem.innerHTML;html=html.trim(),html+=choice,labelElem.innerHTML=html,div.appendChild(clone)}),details.appendChild(div),settingTabpanel[1].appendChild(details)}}),lang()}changeChoices(),["all1check","all2check","all3check"].forEach(item=>{const elem=document.getElementById(item);elem.addEventListener("click",()=>{const inputs=elem.nextElementSibling.getElementsByTagName("input");for(let i=0;i<inputs.length;i++)inputs[i].checked=!elem.classList.contains("checked");elem.classList.toggle("checked");const message={ja:["をすベて選択","の選択をすべて解除"],"en-us":["Select","Deselect"]};supportedLang.forEach(lang=>{elem.classList.contains("checked")||message[lang].reverse(),elem.innerHTML=elem.innerHTML.replace(message[lang][0],message[lang][1])})})});const testH2=document.getElementById("testH2"),questionTemp=document.getElementById("questionTemp");function makeTest(){const hiddenElem=[...settingTabpanel].filter(elem=>elem.hasAttribute("hidden")),kind=hiddenElem[0]===settingTabpanel[1]?"ramdom":"select",studyYear=getMultiple(studyYearBtns);if(!studyYear.length)return void alert("学習年をひとつ以上選択してください。");if("select"===kind&&!getMultiple(kanjiChoicesElems).length)return void alert("漢字をひとつ以上選択してください。");for(testH2.removeAttribute("hidden"),testAreaElem.removeAttribute("hidden");questionsDiv.firstChild;)questionsDiv.firstChild.remove();let qKanji,qNum;if("ramdom"===kind)qNum=Number(qNumElem.value),qNumElem.max<qNum?(qNum=qNumElem.max,qNumElem.value=qNum):qNum<qNumElem.min&&(qNum=qNumElem.min,qNumElem.value=qNum),qKanji=ramdomSelect(qNum,studyYear);else{const kanjis=getMultiple(kanjiChoicesElems);qNum=kanjis.length,qKanji=shuffle(kanjis)}maxScoreElem.textContent=qNum;const fragment=document.createDocumentFragment();qKanji.forEach(kanji=>{const test=kanjiData[kanji].test,phraseNum=Math.floor(Math.random()*test.length),clone=questionTemp.content.cloneNode(!0),questionElem=clone.querySelector(".question"),phraseElem=questionElem.getElementsByClassName("phrase")[0];test[phraseNum].hasOkurigana?(questionElem.classList.add("okurigana"),test[phraseNum].phrase.forEach(phrase=>{if(phrase.answer){const yomigana=document.createElement("span");yomigana.classList.add("yomigana"),yomigana.textContent=phrase.text,phraseElem.appendChild(yomigana);const blankElem=document.createElement("div");blankElem.classList.add("blank");const answerElem=document.createElement("span");answerElem.textContent=phrase.answer,answerElem.classList.add("answer"),phrase.answer.length>=4&&answerElem.classList.add("long"),answerElem.setAttribute("hidden",""),blankElem.appendChild(answerElem),questionElem.appendChild(blankElem)}else phraseElem.innerHTML+=phrase.text})):(questionElem.classList.add("tango"),test[phraseNum].phrase.forEach(phrase=>{if(phrase.answer){const blankElem=document.createElement("div");blankElem.classList.add("blank"),phraseElem.appendChild(blankElem);const yomigana=document.createElement("span");yomigana.classList.add("yomigana"),phrase.text.length>=3&&yomigana.classList.add("long"),yomigana.textContent=phrase.text,blankElem.appendChild(yomigana);const answerElem=document.createElement("span");answerElem.textContent=phrase.answer,answerElem.classList.add("answer"),answerElem.setAttribute("hidden",""),blankElem.appendChild(answerElem)}else phraseElem.innerHTML+=phrase.text})),fragment.appendChild(clone)}),questionsDiv.appendChild(fragment);const maxYear=Math.max(...studyYear),maxYearElems=document.querySelectorAll(`[data-year="${maxYear}"]`);for(let i=0;i<maxYearElems.length;i++)maxYearElems[i].removeAttribute("hidden");const otherYears=[1,2,3].filter(num=>num!==maxYear);for(let i=0;i<otherYears.length;i++){const otherYearsElems=document.querySelectorAll(`[data-year="${otherYears[i]}"]`);for(let y=0;y<otherYearsElems.length;y++)otherYearsElems[y].setAttribute("hidden","")}}for(let i=0;i<studyYearBtns.length;i++)studyYearBtns[i].addEventListener("change",()=>{const studyYear=getMultiple(studyYearBtns),maxKanjiNum=filterByYear(studyYear).length;qNumElem.max=maxKanjiNum,"0"===qNumElem.value&&(qNumElem.value=16),Number(qNumElem.value)>Number(qNumElem.max)&&(qNumElem.value=qNumElem.max),changeChoices()});function showAnswer(){const answerElems=document.getElementsByClassName("answer");if(answerBtn.checked)for(let i=0;i<answerElems.length;i++)answerElems[i].removeAttribute("hidden");else for(let i=0;i<answerElems.length;i++)answerElems[i].setAttribute("hidden","")}makeTestBtn.addEventListener("click",()=>{if(makeTest(),!testArea.hasAttribute("hidden")){const message={ja:"テストを更新","en-us":"Update test"};supportedLang.forEach(lang=>{makeTestBtn.querySelector(`:lang(${lang})`).textContent=message[lang]}),printBtn.removeAttribute("hidden"),printAnsBtn.removeAttribute("hidden")}}),printBtn.addEventListener("click",()=>{window.print()}),printAnsBtn.addEventListener("click",()=>{answerBtn.click(),window.print(),answerBtn.click()}),window.addEventListener("beforeprint",()=>{const printArea=document.createElement("div");function sliceByNumber(array,number){const elements=[...array],length=Math.ceil(elements.length/number);return new Array(length).fill().map((_,i)=>elements.slice(i*number,(i+1)*number))}printArea.setAttribute("id","printArea");const fragment=document.createDocumentFragment();sliceByNumber(questionsDiv.children,8).forEach(elemGroup=>{const div=document.createElement("div");div.classList.add("row"),elemGroup.forEach(elem=>{div.appendChild(elem)}),fragment.appendChild(div)}),questionsDiv.appendChild(fragment),document.body.appendChild(printArea),printArea.appendChild(testAreaElem.cloneNode(!0)),document.body.firstElementChild.setAttribute("hidden","")}),window.addEventListener("afterprint",()=>{const elem=document.body.firstElementChild;if(elem.hasAttribute("hidden")){elem.removeAttribute("hidden"),document.getElementById("printArea").remove();const rowElem=document.getElementsByClassName("row"),fragment=document.createDocumentFragment();for(;rowElem[0];){for(;rowElem[0].firstElementChild;)fragment.appendChild(rowElem[0].firstElementChild);rowElem[0].remove()}questionsDiv.appendChild(fragment)}}),answerBtn.addEventListener("click",showAnswer)}).catch(e=>{console.error(e.message)});