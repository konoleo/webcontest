fetch("../data/kanjidata.json").then(response=>response.ok?response.json():Promise.reject(new Error("JSONファイルにアクセスできません。"))).then(kanjiData=>{function filterBy(data,name,value,option){const dontGetKey=!1===option.key;if(dontGetKey)var newArr={};else var newArr=[];return Object.keys(data).forEach(key=>{value.includes(data[key][name])&&(dontGetKey?newArr[key]=data[key]:newArr.push(key))}),newArr}function shuffle(array){for(let i=array.length-1;0<i;i--){const r=Math.floor(Math.random()*(i+1)),tmp=array[i];array[i]=array[r],array[r]=tmp}return array}function getMultiple(elems){const values=[];for(let i=0;i<elems.length;i++)if(elems[i].checked){const num=Number(elems[i].value);Number.isNaN(num)?values.push(elems[i].value):values.push(Number(elems[i].value))}return values}function ordinalSuffix(i){var j=i%10,k=i%100;return 1==j&&11!=k?i+"st":2==j&&12!=k?i+"nd":3==j&&13!=k?i+"rd":i+"th"}function sliceByNumber(array,number){const elements=[...array],length=Math.ceil(elements.length/number);return new Array(length).fill().map((_,i)=>elements.slice(i*number,(i+1)*number))}var arr=[];Object.keys(kanjiData).forEach(key=>{arr.push(kanjiData[key].studyYear)});const yearsArr=Array.from(new Set(arr)),studyYearsE=document.getElementById("studyYears");yearsArr.forEach(year=>{const elem=`<label><input type="checkbox" name="studyYear" checked value="${year}"><span lang="ja">${year}年生${4===year?"（前期）":""}</span><span lang="en-us" hidden>${ordinalSuffix(year)} grade ${4===year?"(first semester)":""}</span></label>`;studyYearsE.innerHTML+=elem});const tab01=document.getElementById("tab01"),tabContent=tab01.querySelectorAll(".tabContents .tabWrapper"),questionsRows=document.getElementsByClassName("row"),studyYearBtns=document.getElementsByName("studyYear"),randomCheckElem=document.getElementById("randomCheck"),questionCounter=document.getElementById("questionCounter"),qCount=document.getElementsByClassName("qCount"),sheetsCount=document.getElementsByClassName("sheetsCount"),qNumElem=document.getElementById("qNum"),kanjiChoicesElems=document.getElementsByName("kanjiChoices"),answerBtnLabel=document.getElementById("answerBtnLabel"),answerBtn=document.getElementById("answer"),makeTestBtn=document.getElementById("makeTest"),printBtn=document.getElementById("printTest"),printAnsBtn=document.getElementById("printAnswer"),testAreaElem=document.getElementById("testArea"),maxScoreElem=document.getElementById("maxScore");function changeChoices(){const checkedYear=getMultiple(studyYearBtns);if(tabContent[1].getElementsByTagName("details").length){checkedYear.forEach(year=>{tabContent[1].querySelector(`#details${year}`).removeAttribute("hidden")});const otherYears=yearsArr.filter(num=>!checkedYear.includes(num));otherYears.forEach(year=>{const elem=tabContent[1].querySelector(`#details${year}`);elem.setAttribute("hidden",""),elem.querySelectorAll(".kanjiChoicesDiv input").forEach(input=>{input.checked=!1})})}else{checkedYear.forEach(year=>{const choices=filterBy(kanjiData,"studyYear",[year],{key:!1}),keys=Object.keys(choices);if(keys.length){const clone1=document.getElementById("detailsTemp").content.cloneNode(!0),details=clone1.querySelector("details");details.setAttribute("id",`details${year}`);const h2=clone1.querySelector("h2");h2.setAttribute("id",`kanjiOf${year}`),h2.querySelector("[lang=ja]").textContent=`${year}年生${4===year?"（前期）":""}`,h2.querySelector("[lang=en-us]").textContent=`${ordinalSuffix(year)} grade ${4===year?"(first semester)":""}`;const kanjiChoicesTemp=document.getElementById("kanjiChoicesTemp"),strokeTitleTemp=document.getElementById("strokeTitleTemp"),maxStrokeNum=Math.max(...Object.values(choices).map(e=>e.strokesNum));let i=1;for(;i<=maxStrokeNum;){const filteredData=filterBy(choices,"strokesNum",[i],{});if(filteredData.length){const clone2=strokeTitleTemp.content.cloneNode(!0);clone2.querySelector("[lang=ja]").textContent=`${i}画`,clone2.querySelector("[lang=en-us]").textContent=`${i} stroke${1!==i?"s":""}`;const kanjiChoicesDiv=clone2.querySelector(".kanjiChoicesDiv");details.appendChild(clone2),filteredData.forEach(choice=>{const clone3=kanjiChoicesTemp.content.cloneNode(!0),labelElem=clone3.querySelector("label");labelElem.children[0].value=choice;let html=labelElem.innerHTML;html=html.trim(),html+=choice,labelElem.innerHTML=html,kanjiChoicesDiv.appendChild(clone3)})}i++}tabContent[1].appendChild(clone1)}});const data={questions:{elem:qCount,replaceText:[["questions ","question "],["are","is"]]},sheets:{elem:sheetsCount,replaceText:[["sheets)","sheet)"]]}};for(const input of kanjiChoicesElems)input.addEventListener("change",()=>{input.checked?input.parentElement.classList.add("checked"):input.parentElement.classList.remove("checked");const num=getMultiple(kanjiChoicesElems).length,sheetsNum=0===num?0:Math.ceil(Math.ceil((num-16)/8)/3)+1;data.questions.data=num,data.sheets.data=sheetsNum;for(let i=0;i<qCount.length;i++)Object.keys(data).forEach(key=>{const elem=data[key].elem[i],data2=data[key].data;elem.textContent=data2;const parent=elem.parentElement;"en-us"===parent.getAttribute("lang")&&data[key].replaceText.forEach(arr=>{parent.innerHTML=parent.innerHTML.replace(arr[1===data2?0:1],arr[1===data2?1:0])})});updateTestBtn&&updateTestBtn.click()});lang()}const yearsElem=tabContent[0].getElementsByClassName("years");yearsElem[0].textContent="",yearsElem[1].textContent="",checkedYear.forEach(year=>{yearsElem[0].textContent+=`${year}年生${4===year?"（前期）":""}`,yearsElem[0].textContent+="、",yearsElem[1].textContent+=`${ordinalSuffix(year)}${4===year?" (first semester)":""}`,yearsElem[1].textContent+=", "}),yearsElem[0].textContent=yearsElem[0].textContent.replace(/、$/,""),yearsElem[1].textContent=yearsElem[1].textContent.replace(/, $/,""),yearsElem[1].textContent=yearsElem[1].textContent.replace(/(.*),/,"$1 and")}changeChoices();const r1=questionCounter.getBoundingClientRect();function ramdomSelect(){Array.from(kanjiChoicesElems).forEach(input=>{input.checked&&(input.checked=!1,input.dispatchEvent(new Event("change")))});const random=shuffle(Array.from(kanjiChoicesElems)).slice(0,qNumElem.value);random.forEach(input=>{input.checked=!0,input.dispatchEvent(new Event("change"))})}window.addEventListener("scroll",()=>{const r2=makeTestBtn.getBoundingClientRect().top+window.pageYOffset-600;r2<r1.top+window.pageYOffset?questionCounter.setAttribute("hidden",""):questionCounter.removeAttribute("hidden")}),yearsArr.forEach(year=>{const elem=document.querySelector(`#details${year} button`);elem.addEventListener("click",()=>{const inputs=elem.parentElement.querySelectorAll("[name=kanjiChoices]"),trueOrFalse=!elem.classList.contains("checked");for(const input of inputs)input.checked=trueOrFalse,input.dispatchEvent(new Event("change"));elem.classList.toggle("checked");const message={ja:["選択","選択解除"],"en-us":["Select","Deselect"]};supportedLang.forEach(lang=>{trueOrFalse&&message[lang].reverse(),elem.innerHTML=elem.innerHTML.replace(message[lang][1],message[lang][0])})})}),qNumElem.addEventListener("focus",()=>{randomCheckElem.removeEventListener("click",ramdomSelect)}),qNumElem.addEventListener("blur",()=>{randomCheckElem.addEventListener("click",ramdomSelect)}),qNumElem.addEventListener("change",ramdomSelect),randomCheckElem.addEventListener("click",ramdomSelect);const testH2=document.getElementById("testH2"),questionTemp=document.getElementById("questionTemp");function makeTest(){const hiddenElem=[...tabContent].filter(elem=>!elem.classList.contains("activeContent")),kind=hiddenElem[0]===tabContent[1]?"grade":"select",activeYear=getMultiple(studyYearBtns);if(!activeYear.length)return void alert("学習年をひとつ以上選択してください。");if("select"===kind&&!getMultiple(kanjiChoicesElems).length)return void alert("漢字をひとつ以上選択してください。");for(testAreaElem.removeAttribute("hidden");questionsRows[0];)questionsRows[0].remove();let qKanji,qNum;if("grade"===kind)qKanji=filterBy(kanjiData,"studyYear",activeYear,{}),qKanji=shuffle(qKanji),qNum=qKanji.length;else{const kanjis=getMultiple(kanjiChoicesElems);qNum=kanjis.length,qKanji=shuffle(kanjis)}maxScoreElem.textContent=qNum;const fragment=document.createDocumentFragment();qKanji=sliceByNumber(qKanji,8),qKanji.forEach(row=>{const div=document.createElement("div");div.classList.add("row"),row.forEach(kanji=>{const test=kanjiData[kanji].test,phraseNum=Math.floor(Math.random()*test.length),clone=questionTemp.content.cloneNode(!0),questionElem=clone.querySelector(".question"),phraseElem=questionElem.getElementsByClassName("phrase")[0];test[phraseNum].hasOkurigana?(questionElem.classList.add("okurigana"),test[phraseNum].phrase.forEach(phrase=>{if(phrase.answer){const reading=document.createElement("span");reading.classList.add("reading"),reading.textContent=phrase.reading,phraseElem.appendChild(reading);const blankElem=document.createElement("div");blankElem.classList.add("blank");const answerElem=document.createElement("span");answerElem.textContent=phrase.answer,answerElem.classList.add("answer"),phrase.answer.length>=4&&answerElem.classList.add("long"),answerElem.setAttribute("hidden",""),blankElem.appendChild(answerElem),questionElem.appendChild(blankElem)}else phraseElem.innerHTML+=phrase.text})):(questionElem.classList.add("tango"),test[phraseNum].phrase.forEach(phrase=>{if(phrase.answer)if("object"==typeof phrase.answer){const tokubetsuElem=document.createElement("div");tokubetsuElem.classList.add("tokubetsu"),phraseElem.appendChild(tokubetsuElem);const reading=document.createElement("span");reading.classList.add("reading"),reading.textContent=phrase.reading,tokubetsuElem.appendChild(reading),phrase.answer.forEach(elem=>{if(elem.answer){const blankElem=document.createElement("div");blankElem.classList.add("blank"),tokubetsuElem.appendChild(blankElem);const answerElem=document.createElement("span");answerElem.textContent=elem.answer,answerElem.classList.add("answer"),answerElem.setAttribute("hidden",""),blankElem.appendChild(answerElem)}else tokubetsuElem.innerHTML+=elem.text})}else{const blankElem=document.createElement("div");blankElem.classList.add("blank"),phraseElem.appendChild(blankElem);const answerElem=document.createElement("span");answerElem.textContent=phrase.answer,answerElem.classList.add("answer"),answerElem.setAttribute("hidden",""),blankElem.appendChild(answerElem);const reading=document.createElement("span");reading.classList.add("reading"),phrase.reading.length>=3&&reading.classList.add("long"),reading.textContent=phrase.reading,blankElem.appendChild(reading)}else phraseElem.innerHTML+=phrase.text})),div.appendChild(clone)}),fragment.appendChild(div)}),testAreaElem.appendChild(fragment);const maxYear=Math.max(...activeYear),maxYearElems=document.querySelectorAll(`[data-year="${maxYear}"]`);for(let i=0;i<maxYearElems.length;i++)maxYearElems[i].removeAttribute("hidden");const otherYears=yearsArr.filter(num=>num!==maxYear);for(let i=0;i<otherYears.length;i++){const otherYearsElems=document.querySelectorAll(`[data-year="${otherYears[i]}"]`);for(let y=0;y<otherYearsElems.length;y++)otherYearsElems[y].setAttribute("hidden","")}}const kanjiNum=filterBy(kanjiData,"studyYear",yearsArr,{}).length;qNumElem.max=kanjiNum;for(const btn of studyYearBtns)btn.addEventListener("change",()=>{const studyYear=getMultiple(studyYearBtns),maxKanjiNum=filterBy(kanjiData,"studyYear",studyYear,{}).length;qNumElem.max=maxKanjiNum,"0"===qNumElem.value&&(qNumElem.value=40),Number(qNumElem.value)>Number(qNumElem.max)&&(qNumElem.value=qNumElem.max),changeChoices(),updateTestBtn&&updateTestBtn.click()});let updateTestBtn;function showAnswer(){const answerElems=document.getElementsByClassName("answer");if(answerBtn.checked)for(const elem of answerElems)elem.removeAttribute("hidden");else for(const elem of answerElems)elem.setAttribute("hidden","")}makeTestBtn.addEventListener("click",()=>{if(makeTest(),!testAreaElem.hasAttribute("hidden")){updateTestBtn=makeTestBtn;const message={ja:"テストを更新","en-us":"Update test"};supportedLang.forEach(lang=>{makeTestBtn.querySelector(`:lang(${lang})`).textContent=message[lang]}),testH2.removeAttribute("hidden"),answerBtnLabel.removeAttribute("hidden"),printBtn.removeAttribute("hidden"),printAnsBtn.removeAttribute("hidden")}}),[printBtn,printAnsBtn].forEach(btn=>{btn.addEventListener("click",()=>{const original=answerBtn.checked;window.onbeforeprint=function(){answerBtn.checked=btn!==printBtn,showAnswer()},window.onafterprint=function(){answerBtn.checked=original,showAnswer()},window.print()})}),window.addEventListener("beforeprint",()=>{const printArea=document.createElement("div");printArea.setAttribute("id","printArea"),document.body.appendChild(printArea),printArea.appendChild(testAreaElem.cloneNode(!0)),document.body.firstElementChild.setAttribute("hidden","")}),window.addEventListener("afterprint",()=>{const elem=document.body.firstElementChild;elem.hasAttribute("hidden")&&(elem.removeAttribute("hidden"),document.getElementById("printArea").remove())}),answerBtn.addEventListener("click",showAnswer)}).catch(e=>{console.error(e.message)});